---
name: scrum-master
description: ユーザーのプロンプトをタスク分解し、サブエージェントにスキルを委譲して実行するオーケストレーター。
  複雑なリクエスト、複数ステップの作業、「〜を作って〜して」のような複合依頼で発動する。
  スプリント制で段階的に実行し、各スプリント完了時にユーザーに確認する。
  スキルが足りない場合はskill-creatorでスキルを作成する。
---

# scrum-master

ユーザーのプロンプトをバックログに分解し、スプリント単位でサブエージェントに委譲して実行するオーケストレーター。

## 実行ループ

以下のフェーズを順に実行する。

### Phase 1: スキル探索

利用可能なスキルを把握する。

```bash
python .github/skills/scrum-master/scripts/discover_skills.py .github/skills
```

出力されたJSON一覧を記憶する。以降のタスク分解でスキルマッチングに使う。

### Phase 2: バックログ作成

ユーザーのプロンプトからバックログを作成する。

1. ゴール（最終目標）を1文で定義する
2. ゴール達成に必要な全タスクを洗い出す
3. 各タスクに以下を設定する:
   - **action**: 具体的な作業内容
   - **priority**: 実行優先度（1が最高）
   - **done_criteria**: 完了の定義
   - **skill**: Phase 1のスキル一覧からマッチするスキル名。該当なしはnull
   - **depends_on**: 先行タスクのID
4. スキーマ詳細は [references/plan-schema.md](references/plan-schema.md) を参照する

**タスク分解の粒度:**
- 1タスク = 1スキルの1回の実行
- 「AしてBする」は2タスクに分ける
- 汎用タスク（skill: null）は判断・調査・確認など、スキル不要な軽微な作業に限定する

### Phase 3: スキルギャップ解決

バックログ内にskill: nullでかつスキルが必要と判断されるタスクがある場合:

1. ユーザーに報告する:
   ```
   以下のタスクに対応するスキルがありません:
   - [タスク内容]

   選択肢:
   1. 新しいスキルを作成する（skill-creatorを使用）
   2. スキルなしで実行を試みる
   3. このタスクをスキップする
   ```
2. ユーザーが「作成する」を選んだ場合:
   - サブエージェントを起動する
   - skill-creatorの SKILL.md を読み込ませる
   - 「○○のスキルを作成して。ユーザーに要件を確認しながら進めて」と指示する
   - サブエージェントがユーザーと対話しながらスキルを作成する
   - 完了後、Phase 1を再実行してスキル一覧を更新する
   - バックログのskillフィールドを新スキル名で更新する

### Phase 4: スプリントプランニング

バックログからスプリントに含めるタスクを選出する。

1. priority順にタスクを並べる
2. depends_onの制約を考慮し、先行タスクが未完了のタスクは選出しない
3. 1スプリント = 3〜5タスクを目安にする
4. プランJSONを生成する
5. バリデーションを実行する:
   ```bash
   python .github/skills/scrum-master/scripts/validate_plan.py plan.json --skills-json skills.json
   ```
6. プランをユーザーに提示して承認を得る:
   ```
   Sprint N プラン:
   1. [タスク内容] (skill: xxx)
   2. [タスク内容] (skill: yyy)
   3. [タスク内容] (skill: null)

   このプランで進めますか？
   ```

### Phase 5: タスク実行

スプリント内のタスクを直列で実行する。各タスクはサブエージェントに委譲する。

各タスクについて以下を行う:

1. タスクのstatusを `in_progress` に更新する
2. **skill指定ありの場合**: サブエージェントを起動する
   - 該当スキルの SKILL.md をサブエージェントに読み込ませる
   - タスクのactionとコンテキスト（先行タスクのresult等）をプロンプトとして渡す
   - サブエージェントの完了を待つ
3. **skill: null の場合**: 自身で直接実行する（調査、判断、ファイル操作等）
4. 結果をtaskのresultフィールドに記録する
5. done_criteriaに照らして完了判定する:
   - 満たす → status: `completed`
   - 満たさない → status: `failed`、理由をresultに記録
6. **タスク失敗時**: ユーザーに報告する
   ```
   タスク [id] が失敗しました:
   - 内容: [action]
   - 理由: [result]

   選択肢:
   1. リトライする
   2. スキップして次へ進む
   3. スプリントを中断する
   ```

### Phase 6: スプリントレビュー

スプリント内の全タスク完了後（またはユーザーが中断を選択後）:

1. 各タスクの結果をまとめる
2. 成果物を確認する
3. sprintsのreviewフィールドに記録する

### Phase 7: レトロスペクティブ

スプリントのプロセスを振り返る:

1. うまくいったこと / いかなかったことを分析する
2. 改善点があればsprintsのretroフィールドに記録する
3. ブロッカーがあればimpedimentsに記録する

### Phase 8: 進捗レポートと継続判断

ユーザーに進捗を報告し、次のアクションを確認する。

```
Sprint N 完了:
- 完了: X 件
- 失敗: Y 件
- スキップ: Z 件

バックログ残り: W 件
全体進捗: XX%

選択肢:
1. 次のスプリントへ進む
2. バックログを見直す（タスクの追加・削除・優先度変更）
3. ここで完了とする
```

- 「次スプリント」→ Phase 4 に戻る（Phase 1を再実行してスキル一覧を更新してもよい）
- 「バックログ見直し」→ ユーザーと対話してバックログを修正 → Phase 4 に戻る
- 「完了」→ 最終レポートを出力して終了する

## サブエージェントへの指示テンプレート

**重要**: SKILL.md の内容をプロンプトに埋め込まない。ファイルパスだけ渡し、サブエージェント自身に読ませる。これによりプロンプトを短く保ち、安定性を確保する。

### スキル実行時

```
[skill-name] スキルを実行する。

手順: まず [skill-md-path] を読んで手順に従ってください。
タスク: [action]
コンテキスト: [先行タスクのresultを1〜2行で要約]
完了基準: [done_criteria]
```

### スキル作成時

```
skill-creator スキルで新しいスキルを作成する。

手順: まず .github/skills/skill-creator/SKILL.md を読んで手順に従ってください。
作成するスキル: [概要]
配置先: .github/skills/
ユーザーに要件を確認しながら進めること。
```

## エラーハンドリング

| 状況 | 対応 |
|---|---|
| discover_skills.py 実行失敗 | .github/skills/ ディレクトリの存在を確認。なければ作成を提案する |
| validate_plan.py バリデーション失敗 | エラー内容に従ってプランJSONを修正し再検証する |
| サブエージェント実行失敗 | ユーザーにリトライ/スキップ/中断の選択肢を提示する |
| 全タスク失敗 | ゴール自体の実現可能性をユーザーと再検討する |
