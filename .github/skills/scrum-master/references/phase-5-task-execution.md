# Phase 5: タスク実行

> **開始時出力**: `=== PHASE 5: タスク実行 開始 ===`

スプリント内のタスクをウェーブ単位で実行する。同一ウェーブ内のタスクは並列にサブエージェントへ委譲し、ウェーブ間は直列で進行する。

> **委譲必須**: バックログタスクは**サブエージェントで実行する**。スクラムマスターが直接実行してよいのは skill: null の軽微な調査・確認のみ。
> - **GitHub Copilot (VSCode)**: `#tool:agent/runSubagent` を使用
> - **Claude Code**: `Task` ツールを使用

## 実行フロー

```
Wave 1: [b1, b2] → 並列実行 → 全完了を待機
         ↓
Wave 2: [b3, b4] → 並列実行 → 全完了を待機
         ↓
Wave 3: [b5]     → 単独実行
```

## 手順

`execution_groups` の各ウェーブを順に処理する:

1. **ウェーブ開始**: ウェーブ内の全タスクのstatusを `in_progress` に更新する
2. **並列起動**: ウェーブ内の全タスクについてサブエージェントを**同時に**起動する（単一メッセージに並べる）
   - **skill 指定あり** → テンプレート（`subagent-templates.md`「スキル実行時」参照）:
     ```
     [skill-name] スキルを実行する。

     手順: まず [skill-md-path] を読んで手順に従ってください。
     タスク: [action]
     コンテキスト: [先行タスクのresultを1〜2行で要約]
     完了基準: [done_criteria]
     フィードバック: 実行後フィードバック節はスキップしてください。

     結果を以下の形式で返してください:
     ステータス: 成功 / 失敗
     サマリー: [1〜2文で結果を説明]
     ```
   - **skill: null** → テンプレート（`subagent-templates.md`「skill: null タスク実行時」参照）:
     ```
     以下のタスクを実行してください。

     タスク: [action]
     コンテキスト: [先行タスクのresultを1〜2行で要約]
     完了基準: [done_criteria]

     結果を以下の形式で返してください:
     ステータス: 成功 / 失敗
     サマリー: [1〜2文で結果を説明]
     ```
   - **注意**: Wave 1 ではコンテキストは前スプリントの結果のみ。Wave 2 以降は前ウェーブの結果を含める
3. **結果収集**: 全サブエージェントの完了を待ち、各タスクの result フィールドに結果を記録する
4. **完了判定**: 各タスクの done_criteria に照らして判定する:
   - 満たす → status: `completed`
   - 満たさない → status: `failed`、理由を result に記録
5. **ウェーブ内失敗時の判断**:
   - 失敗タスクに後続ウェーブのタスクが依存している場合 → ユーザーに報告する:
     ```
     Wave [N] 実行結果:
     - [id]: 完了 ✓
     - [id]: 失敗 ✗ — [理由]

     失敗タスクに依存する後続タスク: [ids]

     選択肢:
     1. 失敗タスクをリトライする（後続タスクは待機）
     2. 失敗タスクをスキップし、依存タスクもスキップする
     3. スプリントを中断する
     ```
   - 失敗タスクに依存するタスクがない場合 → 報告のみで次ウェーブへ進む
6. **次のウェーブへ**: 依存先が失敗したタスクは status: `skipped` にしてスキップする

## 並列実行の制約

- 同一ファイルを編集するタスクが同一ウェーブに含まれる場合、コンフリクト防止のためウェーブを分割する（Phase 4 で考慮）
- ユーザーへの対話的な確認が必要なタスク（skill: null）は単独ウェーブに分離することを推奨する

## ゲート条件（Phase 6 に進む前に確認）

- [ ] 全ウェーブの実行が完了した（またはユーザーが中断を選択した）
- [ ] 各タスクの status と result が `plan.json` に記録されている

→ 条件を満たしたら **Phase 6: スプリントレビュー** へ進む
