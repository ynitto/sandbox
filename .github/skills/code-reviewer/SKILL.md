---
name: code-reviewer
description: プルリクエスト単位でdiffベースのコードレビューを実施し、LGTM / Request Changes を判定するスキル。「PRをレビューして」「このPRの問題点を教えて」「コードレビューお願い」「レビューして」「このdiffを確認して」などのリクエストで発動する。セキュリティ・パフォーマンス・可読性の観点で分析し、codebase-to-skill で生成されたプロジェクトスキルがあれば連携して規約準拠もチェックする。sprint-reviewer とは異なり、個別のコード変更に対する詳細レビューに特化する。
---

# code-reviewer

PRのdiffを対象に、セキュリティ・パフォーマンス・可読性の観点でコードをレビューし、LGTM または Request Changes を判定する。プロジェクト固有の規約はプロジェクトスキルまたはユーザー提供ルールから取得して適用する。

## レビューワークフロー

### Step 1: PR情報とdiffを取得する

PR番号が指定されている場合:

```bash
gh pr view <PR番号>        # PRの目的・背景を確認
gh pr diff <PR番号>        # レビュー対象のdiffを取得
```

PR番号がない場合はカレントブランチのdiffを使う:

```bash
git diff main...HEAD
```

PRの目的・変更の意図が不明な場合はユーザーに確認してから進む。

### Step 2: プロジェクト規約を確認する

以下の優先順位でコーディング規約を把握する:

1. **ユーザー提供ルール** — 会話中に明示されたルール・規約（最優先）
2. **プロジェクトスキル** — `codebase-to-skill` で生成されたスキルが `.github/skills/` にある場合は読み込む
3. **規約なし** — 汎用観点のみでレビューする

プロジェクトスキルの確認:

```bash
ls .github/skills/   # プロジェクト固有スキルの有無を確認
```

プロジェクトスキルが見つかった場合はその SKILL.md を読み込み、コーディング規約・設計方針・禁止パターンを把握する。

### Step 3: コーディング規約への準拠をチェックする

Step 2 で取得した規約をdiffに適用する:

- 規約ごとに違反箇所を特定する（ファイル名・行番号で示す）
- 追加行（`+` 行）を中心に確認し、削除行（`-` 行）は参考として使う
- 違反の理由と改善案をセットで示す

### Step 4: 汎用観点でdiffをレビューする

追加・変更されたコードを以下の観点で分析する:

#### セキュリティ
- インジェクション（SQL・コマンド・テンプレートなど）のリスク
- 認証・認可の抜け
- 機密情報のハードコードやログ出力
- 外部入力の無検証利用

#### パフォーマンス
- 不必要な繰り返し処理・重複した計算
- N+1問題など非効率なデータアクセスパターン
- 不要なメモリ確保

#### 可読性・保守性
- 変数名・関数名が意図を正確に表しているか
- 関数・クラスの責務が単一か（過度な複雑さがないか）
- マジックナンバー・ハードコードされた値
- コメントの適切さ（なぜその実装かが伝わるか）

#### 正確性・堅牢性
- ロジックの誤り（条件分岐・ループ・境界値）
- 未処理のエラー・例外
- エッジケース・境界値の考慮
- リソースの適切な解放（ファイル・接続など）

### Step 5: LGTM / Request Changes を判定して報告する

#### 重要度の分類

| 重要度 | 意味 | 対応 |
|--------|------|------|
| **Critical** | バグ・セキュリティ問題・データ破壊の恐れ | 必ず修正 |
| **Warning** | 将来の障害につながるリスク・設計上の問題 | 修正を強く推奨 |
| **Suggestion** | 可読性・保守性の改善案 | 検討を推奨 |

#### 判定ルール

- Critical または Warning が1件以上 → **Request Changes**
- Suggestion のみ → **LGTM**（コメント付き）
- 指摘なし → **LGTM**

#### 報告フォーマット

```
## レビュー結果: [LGTM ✅ | Request Changes ❌]

### コーディング規約への準拠
（規約がある場合のみ）

[ルール名]: ✅ 適合 / ❌ 違反
違反箇所: <ファイル名:行番号>
問題: <説明>
改善案: <提案またはコード例>

### 指摘事項

#### 🔴 Critical
**[カテゴリ] <問題の要約>**
場所: <ファイル名:行番号>
問題: <何が問題か>
改善案:
<修正後のコード例>

#### 🟡 Warning
...（同形式）

#### 🔵 Suggestion
...（同形式）

### サマリー
- Critical: X件 / Warning: X件 / Suggestion: X件
- 判定根拠: <なぜ LGTM または Request Changes か>

<総評: 変更の目的達成度・特に良い点・対処の優先順位>
```

## レビューの原則

- **diffに集中する** — 変更されていないコードへの指摘は最小限にする
- **指摘は具体的に** — 「良くない」ではなく「なぜ問題で、どう直すか」を示す
- **良い点も伝える** — 改善点だけでなく、適切に実装されている部分も言及する
- **根拠を示す** — なぜそれが問題かを説明する
- **文脈を尊重する** — プロジェクトの制約・既存の設計判断を無視した理想論は押し付けない
