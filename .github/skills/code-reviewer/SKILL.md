---
name: code-reviewer
description: コードレビューを実施するスキル。コードをレビューして」「このコードの問題点を教えて」「レビューお願い」「コードチェックして」「品質確認して」などのリクエストで発動する。セキュリティ・パフォーマンス・可読性の観点で分析し、LGTM / Request Changes を判定する。コーディングルールがあれば準拠チェックも行う。
---

# code-reviewer

コードを、セキュリティ・パフォーマンス・可読性の観点でレビューし、LGTM または Request Changes を判定する。コーディングルールがあれば最優先で適用する。

## レビューワークフロー

### Step 1: レビュー対象を確認する

1. **対象コードの役割** — このコードは何をするものか
2. **ユーザー提供のコーディングルール** — 明示されたルール・規約があるか
3. **レビューの深度** — 全体的な品質確認か、特定箇所の集中確認か

変更の目的・背景が不明な場合はユーザーに確認してから進む。

### Step 2: コーディングルールを確認する

以下の優先順位でコーディング規約を把握する:

1. **ユーザー提供ルール** — 会話中に明示されたルール・規約（最優先）
2. **プロジェクトルール** — プロジェクト内 `docs/**/*.md` にコーディング規約がある場合は読み込む
3. **規約なし** — 汎用観点のみでレビューする

ルールが曖昧または部分的な場合は、不明点を確認してから進む。

### Step 3: コーディングルールへの準拠をチェックする

Step 2 でルールがある場合:

- ルールごとに違反箇所を特定する
- 違反の具体的な場所（ファイル名・行番号）を示す
- 違反の理由と改善案をセットで示す

### Step 4: 汎用観点でレビューする

以下の観点でコードを分析する。

#### 正確性
- ロジックの誤り（条件分岐・ループ・境界値）
- 未処理のエラー・例外
- 意図していない副作用
- データの整合性の崩れ

#### 可読性・保守性
- 変数名・関数名と実際の振る舞いの不一致
- 単一責務の逸脱（肥大化した関数・クラス）
- マジックナンバー・ハードコードされた値
- 意図が伝わらないコメント・コメント不足

#### 堅牢性
- 入力値のバリデーション漏れ（特に外部入力）
- エッジケース・境界値の未考慮
- リソースの適切な解放漏れ（ファイル・接続など）
- タイムアウト・リトライの未考慮

#### 一貫性
- コーディングスタイル・命名規則の既存コードとの不統一
- エラーハンドリングパターンの不統一
- API・インターフェース設計の不統一（引数順・戻り値形式など）
- 既存実装と重複・矛盾する処理

#### セキュリティ
- インジェクション（SQL・コマンド・テンプレートなど）のリスク
- 認証・認可の抜け漏れ
- 機密情報のハードコードやログ出力
- 外部入力の無検証利用

#### パフォーマンス
- 不必要な繰り返し処理・重複した計算
- N+1問題など非効率なデータアクセスパターン
- 不要なメモリ確保・解放漏れ
- ブロッキング処理・非同期の不適切な使用

#### テスト容易性
- テストが書きにくい構造になっていないか
- 依存関係が注入可能か
- 副作用が隔離されているか

### Step 5: LGTM / Request Changes を判定して報告する

#### 重要度の分類

| 重要度 | 意味 | 対応 |
|--------|------|------|
| **Critical** | バグ・セキュリティ問題・データ破壊の恐れ | 必ず修正 |
| **Warning** | 将来の障害につながるリスク・設計上の問題 | 修正を強く推奨 |
| **Suggestion** | 可読性・保守性の改善案 | 検討を推奨 |

#### 判定ルール

- Critical または Warning が1件以上 → **Request Changes**
- Suggestion のみ → **LGTM**（コメント付き）
- 指摘なし → **LGTM**

#### 報告フォーマット

```
## レビュー結果: [LGTM ✅ | Request Changes ❌]

### コーディングルールへの準拠
（ルールがある場合のみ）

[ルール名]: ✅ 適合 / ❌ 違反
違反箇所: <ファイル名:行番号>
問題: <説明>
改善案: <提案またはコード例>

### 指摘事項

#### 🔴 Critical
**[カテゴリ] <問題の要約>**
場所: <ファイル名:行番号>
問題: <何が問題か>
改善案:
<修正後のコード例>

#### 🟡 Warning
...（同形式）

#### 🔵 Suggestion
...（同形式）

### サマリー
- Critical: X件 / Warning: X件 / Suggestion: X件
- 判定根拠: <なぜ LGTM または Request Changes か>

<総評: 変更の目的達成度・特に良い点・対処の優先順位>
```

## レビューの原則

- **変更点に集中する** — diffがある場合は変更行を中心にレビューし、未変更コードへの指摘は最小限にする
- **指摘は具体的に** — 「良くない」ではなく「なぜ問題で、どう直すか」を示す
- **良い点も伝える** — 改善点だけでなく、適切に実装されている部分も言及する
- **根拠を示す** — なぜそれが問題かを説明する
- **文脈を尊重する** — プロジェクトの制約・既存の設計判断を無視した理想論は押し付けない
